#!/usr/bin/env bash
# Display IP addresses for each network interface

declare -A ipv4_arrays
declare -A ipv6_arrays

# Add IP address to array for interface
add_ip() {
    local iface=$1
    local ip=$2
    local type=$3
    
    if [[ "$type" == "ipv4" ]]; then
        [[ -z "${ipv4_arrays[$iface]}" ]] && ipv4_arrays[$iface]=""
        [[ -n "${ipv4_arrays[$iface]}" ]] && ipv4_arrays[$iface]+=" "
        ipv4_arrays[$iface]+="$ip"
    else
        [[ -z "${ipv6_arrays[$iface]}" ]] && ipv6_arrays[$iface]=""
        [[ -n "${ipv6_arrays[$iface]}" ]] && ipv6_arrays[$iface]+=" "
        ipv6_arrays[$iface]+="$ip"
    fi
}

# Parse network interface output
# Use cached OS_TYPE if available, fallback to uname
[[ -z "$OS_TYPE" ]] && [[ -f ~/.cache/os-type.cache ]] && OS_TYPE=$(cat ~/.cache/os-type.cache)
[[ -z "$OS_TYPE" ]] && [[ "$(uname)" == "Darwin" ]] && OS_TYPE="mac"

if [[ "$OS_TYPE" == "mac" ]]; then
    command -v ifconfig >/dev/null 2>&1 || exit 0
    
    current_iface=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^([^:]+):[[:space:]]+flags= ]]; then
            current_iface="${BASH_REMATCH[1]}"
            continue
        fi
        
        [[ -z "$current_iface" ]] && continue
        
        if [[ "$line" =~ [[:space:]]+inet[[:space:]]+([0-9.]+) ]]; then
            ip="${BASH_REMATCH[1]}"
            [[ "$ip" =~ ^127\. ]] && continue
            add_ip "$current_iface" "$ip" "ipv4"
        elif [[ "$line" =~ [[:space:]]+inet6[[:space:]]+([0-9a-fA-F:]+) ]]; then
            ip6="${BASH_REMATCH[1]%%%*}"
            [[ "$ip6" == "::1" ]] && continue
            [[ "$ip6" =~ ^fe80:: ]] && continue
            add_ip "$current_iface" "$ip6" "ipv6"
        fi
    done < <(ifconfig -a 2>/dev/null)
else
    command -v ip >/dev/null 2>&1 || exit 0
    
    current_iface=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^[0-9]+:[[:space:]]+([^:]+): ]]; then
            current_iface="${BASH_REMATCH[1]}"
            continue
        fi
        
        [[ -z "$current_iface" ]] && continue
        
        if [[ "$line" =~ [[:space:]]+inet[[:space:]]+([0-9.]+) ]]; then
            ip="${BASH_REMATCH[1]}"
            [[ "$ip" =~ ^127\. ]] && continue
            add_ip "$current_iface" "$ip" "ipv4"
        elif [[ "$line" =~ [[:space:]]+inet6[[:space:]]+([0-9a-fA-F:]+) ]]; then
            ip6="${BASH_REMATCH[1]}"
            [[ "$ip6" == "::1" ]] && continue
            [[ "$ip6" =~ ^fe80:: ]] && continue
            add_ip "$current_iface" "$ip6" "ipv6"
        fi
    done < <(ip addr show 2>/dev/null)
fi

mapfile -t all_interfaces < <(printf '%s\n' "${!ipv4_arrays[@]}" "${!ipv6_arrays[@]}" | sort -u)
[[ ${#all_interfaces[@]} -eq 0 ]] && exit 0

echo ""
echo "IP Addresses:"
indent="      "

for iface in "${all_interfaces[@]}"; do
    v6_addrs=()
    v4_addrs=()
    
    [[ -n "${ipv6_arrays[$iface]}" ]] && read -ra v6_addrs <<< "${ipv6_arrays[$iface]}"
    [[ -n "${ipv4_arrays[$iface]}" ]] && read -ra v4_addrs <<< "${ipv4_arrays[$iface]}"
    
    all_addrs=("${v6_addrs[@]}" "${v4_addrs[@]}")
    [[ ${#all_addrs[@]} -eq 0 ]] && continue
    
    if [[ ${#all_addrs[@]} -eq 1 ]]; then
        printf "  └─ %s\n" "$iface"
        printf "%s└─ %s\n" "$indent" "${all_addrs[0]}"
    elif [[ ${#all_addrs[@]} -le 4 ]]; then
        printf "  └─ %s\n" "$iface"
        for i in $(seq 0 $((${#all_addrs[@]} - 1))); do
            if [[ $i -eq 0 ]]; then
                [[ ${#all_addrs[@]} -eq 2 ]] && printf "%s└─ %s\n" "$indent" "${all_addrs[$i]}" || printf "%s├─ %s\n" "$indent" "${all_addrs[$i]}"
            elif [[ $i -eq $((${#all_addrs[@]} - 1)) ]]; then
                printf "%s└─ %s\n" "$indent" "${all_addrs[$i]}"
            else
                printf "%s├─ %s\n" "$indent" "${all_addrs[$i]}"
            fi
        done
    else
        mid=$(((${#all_addrs[@]} + 1) / 2))
        col_width=36
        second_col_start=45
        iface_prefix_len=5
        iface_end_pos=$((iface_prefix_len + ${#iface}))
        horizontal_line_len=$((second_col_start - iface_end_pos))
        
        if [[ $horizontal_line_len -gt 0 ]]; then
            horizontal_line=""
            for ((k=0; k<horizontal_line_len; k++)); do
                horizontal_line+="─"
            done
            printf "  └─ %s%s┐\n" "$iface" "$horizontal_line"
        else
            printf "  └─ %s\n" "$iface"
        fi
        
        for i in $(seq 0 $(($mid - 1))); do
            j=$((i + mid))
            
            if [[ $i -eq 0 ]]; then
                [[ $mid -eq 1 ]] && [[ $j -ge ${#all_addrs[@]} ]] && tree_char="└─" || tree_char="├─"
            else
                [[ $i -eq $(($mid - 1)) ]] && [[ $j -ge ${#all_addrs[@]} ]] && tree_char="└─" || tree_char="├─"
            fi
            printf "%s%s %-${col_width}s" "$indent" "$tree_char" "${all_addrs[$i]}"
            
            if [[ $j -lt ${#all_addrs[@]} ]]; then
                [[ $j -eq $((${#all_addrs[@]} - 1)) ]] && printf "└─ %s" "${all_addrs[$j]}" || printf "├─ %s" "${all_addrs[$j]}"
            fi
            printf "\n"
        done
    fi
done

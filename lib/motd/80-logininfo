#!/usr/bin/env bash
# Display current login sessions with source and readable timestamp

command -v who >/dev/null 2>&1 || { echo "ERROR: 'who' command not found" >&2; exit 1; }

# Use gdate on macOS, date on Linux
DATE=$(command -v gdate 2>/dev/null || echo date)
user=$(whoami)
now=$($DATE +%s)

# Format source: use IP if available, otherwise terminal name
format_source() {
    echo "${2:-$1}"
}

# Parse login sessions - handle both macOS (YYYY-MM-DD HH:MM) and Linux (MMM DD HH:MM) formats
# Formats: macOS: user console 2025-11-10 15:41 (ip)
#          Linux: user pts/0 2025-11-13 14:36 (ip)
parse_who_line() {
    local fields=($1)
    [[ "${fields[0]}" != "$user" ]] && return
    
    local terminal="${fields[1]}"
    local datetime="${fields[2]} ${fields[3]}"
    local ip=""
    
    # Extract IP from remaining fields (field 4+ with parentheses)
    for field in "${fields[@]:4}"; do
        if [[ "$field" =~ ^\( ]]; then
            ip="${field//[()]/}"
            break
        fi
    done
    
    echo "${terminal}|${datetime}|${ip}"
}

sessions=()
while IFS= read -r line; do
    parsed=$(parse_who_line "$line")
    [[ -n "$parsed" ]] && sessions+=("$parsed")
done < <(who)

[[ ${#sessions[@]} -eq 0 ]] && { echo "No login sessions found"; exit 0; }

# Extract session info
IFS='|' read -r current_terminal current_time current_ip <<< "${sessions[0]}"
IFS='|' read -r last_terminal last_time last_ip <<< "${sessions[-1]}"

current_src=$(format_source "$current_terminal" "$current_ip")
last_src=$(format_source "$last_terminal" "$last_ip")
last_time=$(echo "$last_time" | xargs)

# Parse last login epoch - handle both date formats
if [[ "$last_time" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2} ]]; then
    last_epoch=$($DATE -d "$last_time" +%s 2>/dev/null || echo "0")
else
    last_epoch=$($DATE -d "$last_time" +%s 2>/dev/null || $DATE -d "${last_time}:00" +%s 2>/dev/null || echo "0")
fi

# Format time difference conversationally
format_relative_time() {
    local diff=$1 epoch=$2
    
    if (( diff < 10 )); then
        echo "just now"
    elif (( diff < 60 )); then
        echo "${diff}s ago"
    elif (( diff < 120 )); then
        echo "1 minute ago"
    elif (( diff < 3600 )); then
        echo "$((diff / 60)) minutes ago"
    elif (( diff < 86400 )); then
        echo "at $($DATE -d "@$epoch" +"%H:%M")"
    elif (( diff < 172800 )); then
        echo "at $($DATE -d "@$epoch" +"%H:%M") yesterday"
    else
        local day=$($DATE -d "@$epoch" +"%d" | sed 's/^0*//')
        local suffix="th"
        case $day in
            1|21|31) suffix="st";;
            2|22) suffix="nd";;
            3|23) suffix="rd";;
        esac
        
        local weekday=$($DATE -d "@$epoch" +"%A")
        local month=$($DATE -d "@$epoch" +"%b")
        local time=$($DATE -d "@$epoch" +"%H:%M")
        local login_year=$($DATE -d "@$epoch" +"%Y")
        local this_year=$($DATE +"%Y")
        
        if [[ "$login_year" == "$this_year" ]]; then
            echo "on $weekday $month ${day}${suffix} at $time"
        else
            echo "on $weekday $month ${day}${suffix}, $login_year at $time"
        fi
    fi
}

# Color codes
CYAN="\033[1;36m" GREEN="\033[1;32m" YELLOW="\033[1;33m" RESET="\033[0m"

# Build output message
if [[ $last_epoch -gt 0 ]]; then
    diff=$((now - last_epoch))
    when=$(format_relative_time "$diff" "$last_epoch")
    printf "%bCurrently logged in from%b %b%s%b, %blast logged in from%b %b%s%b %b%s%b\n" \
        "$CYAN" "$RESET" "$GREEN" "$current_src" "$RESET" \
        "$CYAN" "$RESET" "$GREEN" "$last_src" "$RESET" "$YELLOW" "$when" "$RESET"
else
    printf "%bCurrently logged in from%b %b%s%b\n" "$CYAN" "$RESET" "$GREEN" "$current_src" "$RESET"
fi

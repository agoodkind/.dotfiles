#!/usr/bin/env bash
source "$(dirname "$0")/email-guard.sh"
source "$(dirname "$0")/chain-hook.sh"

identity=$(resolve_allowed_identity)
if [[ -n "$identity" ]]; then
    allowed_email=$(echo "$identity" | head -1)
    allowed_name=$(echo "$identity" | tail -1)

    while read -r local_ref local_oid remote_ref remote_oid; do
        [[ "$local_oid" =~ ^0+$ ]] && continue

        if [[ "$remote_oid" =~ ^0+$ ]]; then
            range="$local_oid"
        else
            range="$remote_oid..$local_oid"
        fi

        bad=$(git log "$range" \
            --format="%H %an <%ae>" 2>/dev/null \
            | grep -v "$allowed_name <$allowed_email>" \
            || true)

        if [[ -n "$bad" ]]; then
            echo "error: push blocked, bad author"
            echo "  allowed: $allowed_name <$allowed_email>"
            echo "$bad" | while read -r line; do
                echo "  $line"
            done
            exit 1
        fi
    done
fi

chain_hook pre-push "$@"

#!/usr/bin/env bash
source "$(dirname "$0")/email-guard.sh"
source "$(dirname "$0")/chain-hook.sh"

identity=$(resolve_allowed_identity)
if [[ -n "$identity" ]]; then
    allowed_email=$(echo "$identity" | head -1)
    allowed_name=$(echo "$identity" | tail -1)
    current_email=$(git config user.email)
    current_name=$(git config user.name)

    if [[ "$current_email" != "$allowed_email" \
        || "$current_name" != "$allowed_name" ]]; then
        echo "error: commit blocked"
        echo "  current: $current_name <$current_email>"
        echo "  allowed: $allowed_name <$allowed_email>"
        echo ""
        echo "Fix:"
        if [[ "$current_email" != "$allowed_email" ]]; then
            echo "  git config user.email $allowed_email"
        fi
        if [[ "$current_name" != "$allowed_name" ]]; then
            echo "  git config user.name \"$allowed_name\""
        fi
        exit 1
    fi
fi

chain_hook pre-commit "$@"
